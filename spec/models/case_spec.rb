require "rails_helper"

RSpec.describe Case, :type => :model do
  it "should parse json list payload" do
    payload = '{"total_entries":3,"page":1,"_links":{"self":{"href":"/api/v2/cases?page=1&per_page=50","class":"page"},"first":{"href":"/api/v2/cases?page=1&per_page=50","class":"page"},"last":{"href":"/api/v2/cases?page=1&per_page=50","class":"page"},"previous":null,"next":null},"_embedded":{"entries":[{"id":1,"external_id":null,"blurb":"I want to personally thank you for signing up to try Desk.com! To ensure you get the most out of your trial, here are some helpful tips and quick ways to get started:\n\n1. USE IT - You\u2019ve got 14 days to try us out - please do so and tell us what you t","subject":"Getting Started with Your New Account","priority":4,"locked_until":null,"description":null,"status":"open","type":"email","labels":["Brand New Label","Escalated","Sample Case"],"label_ids":[1944759,1938572,1938570],"language":null,"active_at":"2014-09-08T04:53:44Z","changed_at":"2014-09-08T05:22:58Z","created_at":"2014-09-03T15:25:31Z","updated_at":"2014-09-08T06:33:01Z","received_at":"2014-09-03T15:25:31Z","first_opened_at":"2014-09-08T02:41:39Z","opened_at":"2014-09-08T02:41:39Z","first_resolved_at":null,"resolved_at":null,"custom_fields":{},"_links":{"self":{"href":"/api/v2/cases/1","class":"case"},"message":{"href":"/api/v2/cases/1/message","class":"email"},"customer":{"href":"/api/v2/customers/249541201","class":"customer"},"labels":{"href":"/api/v2/cases/1/labels","class":"label"},"assigned_user":{"href":"/api/v2/users/22330289","class":"user"},"assigned_group":{"href":"/api/v2/groups/441295","class":"group"},"locked_by":null,"history":{"href":"/api/v2/cases/1/history","class":"history"},"case_links":{"href":"/api/v2/cases/1/links","class":"case_link"},"macro_preview":{"href":"/api/v2/cases/1/macros/preview","class":"macro_preview"},"replies":{"href":"/api/v2/cases/1/replies","class":"reply","count":1},"draft":{"href":"/api/v2/cases/1/replies/draft","class":"reply"},"notes":{"href":"/api/v2/cases/1/notes","class":"note","count":0},"attachments":{"href":"/api/v2/cases/1/attachments","class":"attachment","count":0}}},{"id":2,"external_id":null,"blurb":"Desk.com makes it easy to WOW your customers because it gives you the tools to offer super fast customer support. \n\nHere are 3 features our customers love to use to make offering support fast and easy:\n\n1. Macros - Quick shortcuts that allow you to d","subject":"The Top 3 Features Our Customers Love!","priority":9,"locked_until":null,"description":null,"status":"new","type":"phone","labels":["Sample Case"],"label_ids":[1938570],"language":null,"active_at":null,"changed_at":"2014-09-03T15:25:31Z","created_at":"2014-09-03T15:25:31Z","updated_at":"2014-09-03T15:25:31Z","received_at":"2014-09-03T15:25:31Z","first_opened_at":null,"opened_at":null,"first_resolved_at":null,"resolved_at":null,"custom_fields":{},"_links":{"self":{"href":"/api/v2/cases/2","class":"case"},"message":{"href":"/api/v2/cases/2/message","class":"phone"},"customer":{"href":"/api/v2/customers/249541201","class":"customer"},"labels":{"href":"/api/v2/cases/2/labels","class":"label"},"assigned_user":{"href":"/api/v2/users/22330289","class":"user"},"assigned_group":{"href":"/api/v2/groups/441295","class":"group"},"locked_by":null,"history":{"href":"/api/v2/cases/2/history","class":"history"},"case_links":{"href":"/api/v2/cases/2/links","class":"case_link"},"macro_preview":{"href":"/api/v2/cases/2/macros/preview","class":"macro_preview"},"replies":{"href":"/api/v2/cases/2/replies","class":"reply","count":1},"draft":{"href":"/api/v2/cases/2/replies/draft","class":"reply"},"notes":{"href":"/api/v2/cases/2/notes","class":"note","count":0},"attachments":{"href":"/api/v2/cases/2/attachments","class":"attachment","count":0}}},{"id":3,"external_id":null,"blurb":"","subject":"","priority":9,"locked_until":null,"description":null,"status":"open","type":"phone","labels":["This Is Awesome"],"label_ids":[1944707],"language":null,"active_at":"2014-09-05T21:58:44Z","changed_at":"2014-09-08T05:29:14Z","created_at":"2014-09-05T20:59:40Z","updated_at":"2014-09-08T05:29:14Z","received_at":"2014-09-05T20:59:41Z","first_opened_at":"2014-09-05T20:59:41Z","opened_at":"2014-09-05T20:59:41Z","first_resolved_at":null,"resolved_at":null,"custom_fields":{},"_links":{"self":{"href":"/api/v2/cases/3","class":"case"},"message":{"href":"/api/v2/cases/3/message","class":"phone"},"customer":{"href":"/api/v2/customers/250142170","class":"customer"},"labels":{"href":"/api/v2/cases/3/labels","class":"label"},"assigned_user":null,"assigned_group":{"href":"/api/v2/groups/441295","class":"group"},"locked_by":null,"history":{"href":"/api/v2/cases/3/history","class":"history"},"case_links":{"href":"/api/v2/cases/3/links","class":"case_link"},"macro_preview":{"href":"/api/v2/cases/3/macros/preview","class":"macro_preview"},"replies":{"href":"/api/v2/cases/3/replies","class":"reply","count":0},"draft":{"href":"/api/v2/cases/3/replies/draft","class":"reply"},"notes":{"href":"/api/v2/cases/3/notes","class":"note","count":1},"attachments":{"href":"/api/v2/cases/3/attachments","class":"attachment","count":0}}}]}}'

    result = Case.parse_json(payload)
    expect(result.class).to eq(Array)
    expect(result.size).to eq(3)
    expect(result.first.class).to eq(Case)
  end

  it "should parse single entry json payload" do
  	payload = '{"id":1,"external_id":null,"blurb":"I want to personally thank you for signing up to try Desk.com! To ensure you get the most out of your trial, here are some helpful tips and quick ways to get started:\n\n1. USE IT - You\u2019ve got 14 days to try us out - please do so and tell us what you t","subject":"Getting Started with Your New Account","priority":4,"locked_until":null,"description":null,"status":"open","type":"email","labels":["Brand New Label","Escalated","Sample Case"],"label_ids":[1944759,1938572,1938570],"language":null,"active_at":"2014-09-08T04:53:44Z","changed_at":"2014-09-08T05:22:58Z","created_at":"2014-09-03T15:25:31Z","updated_at":"2014-09-08T06:33:01Z","received_at":"2014-09-03T15:25:31Z","first_opened_at":"2014-09-08T02:41:39Z","opened_at":"2014-09-08T02:41:39Z","first_resolved_at":null,"resolved_at":null,"custom_fields":{},"_links":{"self":{"href":"/api/v2/cases/1","class":"case"},"message":{"href":"/api/v2/cases/1/message","class":"email"},"customer":{"href":"/api/v2/customers/249541201","class":"customer"},"labels":{"href":"/api/v2/cases/1/labels","class":"label"},"assigned_user":{"href":"/api/v2/users/22330289","class":"user"},"assigned_group":{"href":"/api/v2/groups/441295","class":"group"},"locked_by":null,"history":{"href":"/api/v2/cases/1/history","class":"history"},"case_links":{"href":"/api/v2/cases/1/links","class":"case_link"},"macro_preview":{"href":"/api/v2/cases/1/macros/preview","class":"macro_preview"},"replies":{"href":"/api/v2/cases/1/replies","class":"reply","count":1},"draft":{"href":"/api/v2/cases/1/replies/draft","class":"reply"},"notes":{"href":"/api/v2/cases/1/notes","class":"note","count":0},"attachments":{"href":"/api/v2/cases/1/attachments","class":"attachment","count":0}}}'

  	result = Case.parse_json(payload)
    expect(result.class).to eq(Case)
  end
end